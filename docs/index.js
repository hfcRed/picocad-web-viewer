!function(){"use strict";var t="undefined"!=typeof Float32Array?Float32Array:Array;function e(){var e=new t(3);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),e();const r=[[0,0,0],[29,43,83],[126,37,83],[0,135,81],[171,82,54],[95,87,79],[194,195,199],[255,241,232],[255,0,77],[255,163,0],[255,236,39],[0,228,54],[41,173,255],[131,118,156],[255,119,168],[255,204,170]];class n{constructor(t,e={}){this.objects=t,this.name=e.name,this.backgroundIndex=e.backgroundIndex??0,this.alphaIndex=e.alphaIndex??0,this.zoomLevel=e.zoomLevel,this.texture=e.texture}backgroundColor(){return r[this.backgroundIndex]}alphaColor(){return r[this.alphaIndex]}}class o{constructor(t,e,r,n,o){this.name=t,this.position=e,this.rotation=r,this.vertices=n,this.faces=o}}class i{constructor(t,e,r,n={}){this.indices=t,this.colorIndex=e,this.uvs=r,this.shading=n.shading??!0,this.texture=n.texture??!0,this.doubleSided=n.doubleSided??!1,this.renderFirst=n.renderFirst??!1}color(){return r[this.colorIndex]}}class a{constructor(t,e={}){this.gl=t,this.cull=e.cull??!0,this.shading=e.shading??!0,this.texture=e.texture??!0,this.clearDepth=e.clearDepth??!1,this.vertices=[],this.normals=[],this.uvs=[],this.colorUVs=[],this.triangles=[]}save(){const t=this.gl;this.vertexCount=this.triangles.length,this.isEmpty()||(this.vertexBuffer=t.createBuffer(),this.uvBuffer=t.createBuffer(),this.colorUVBuffer=t.createBuffer(),this.triangleBuffer=t.createBuffer(),this.shading&&(this.normalBuffer=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.vertices),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.uvBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.uvs),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.colorUVBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.colorUVs),t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.triangleBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.triangles),t.STATIC_DRAW),this.shading&&(t.bindBuffer(t.ARRAY_BUFFER,this.normalBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.normals),t.STATIC_DRAW))),this.uvs=null,this.colorUVs=null,this.normals=null,this.vertices=null,this.triangles=null}isEmpty(){return 0===this.vertexCount}free(){const t=this.gl;t.deleteBuffer(this.vertexBuffer),t.deleteBuffer(this.uvBuffer),t.deleteBuffer(this.colorUVBuffer),t.deleteBuffer(this.triangleBuffer),this.shading&&t.deleteBuffer(this.normalBuffer)}}class s{constructor(t){this.gl=t,this.vertices=[]}save(){const t=this.gl;this.vertexCount=Math.floor(this.vertices.length/3),this.vertexBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.vertices),t.STATIC_DRAW),this.vertices=null}free(){this.gl.deleteBuffer(this.vertexBuffer)}}function l(t,e,n){const{passes:o,wireframe:i}=function(t,e,r){const n=[];for(let e=0;e<16;e++){const r=e%2<1,o=e%4<2,i=e%8<4;n.push(new a(t,{cull:!r,shading:o,texture:i,clearDepth:8===e}))}const o=new s(t),i=o.vertices;for(const t of e.objects){const e=t.position,o=t.vertices.map((t=>[-t[0]-e[0],-t[1]-e[1],t[2]+e[2]]));for(const e of t.faces){const t=e.indices,a=e.uvs,s=n[(e.doubleSided?0:1)+(e.shading?0:2)+(e.texture?0:4)+(e.renderFirst?0:8)],l=s.vertices,f=s.triangles,h=s.normals,d=s.uvs,m=s.colorUVs,g=1/256+e.colorIndex*(1/128),p=1,x=Math.floor(l.length/3),v=[],_=[];for(let e=0;e<t.length;e++){const r=o[t[e]],n=o[t[0===e?t.length-1:e-1]],s=a[e];v.push(r),i.push(r[0],r[1],r[2],n[0],n[1],n[2]),_.push([s[0]/16,s[1]/16])}const T=u(v);if(4===t.length&&e.texture&&r>1){const t=v[0],e=v[1],n=v[2],o=v[3],i=_[0],a=_[1],s=_[2],u=_[3];for(let f=0;f<=r;f++){const x=f/r,v=[c(t[0],e[0],x),c(t[1],e[1],x),c(t[2],e[2],x),c(i[0],a[0],x),c(i[1],a[1],x)],_=[c(o[0],n[0],x),c(o[1],n[1],x),c(o[2],n[2],x),c(u[0],s[0],x),c(u[1],s[1],x)];for(let t=0;t<=r;t++){const e=t/r;l.push(c(v[0],_[0],e),c(v[1],_[1],e),c(v[2],_[2],e)),d.push(c(v[3],_[3],e),c(v[4],_[4],e)),m.push(g,p),h.push(T[0],T[1],T[2])}}for(let t=0;t<r;t++)for(let e=0;e<r;e++){const n=e*(r+1),o=x+n+t+1,i=x+n+t+r+1;f.push(x+n+t,o,i,i,o,x+n+t+r+2)}}else{for(const t of v)l.push(t[0],t[1],t[2]),h.push(T[0],T[1],T[2]);for(let t=0;t<_.length;t++)if(m.push(g,p),e.texture){const e=_[t];d.push(e[0],e[1])}else d.push(g,p);for(let e=0,r=t.length-2;e<r;e++)f.push(x+1+e,x,x+2+e)}}}for(const t of n)t.save();return o.save(),{passes:n,wireframe:o}}(t,e,n+1),l=function(t,e){const n=new ImageData(128,128),o=n.data,i=Array(16384).fill(255);let a=0,s=0;for(let n=0;n<120;n++)for(let n=0;n<128;n++){const n=t[a];if(n===e)i[a]=255;else{i[a]=n;const t=r[n];o[s]=t[0],o[s+1]=t[1],o[s+2]=t[2],o[s+3]=255}a++,s+=4}for(let t=0;t<16;t++){i[16256+t]=t;const e=r[t],n=65024+4*t;o[n]=e[0],o[n+1]=e[1],o[n+2]=e[2],o[n+3]=255}return{colors:n,indices:i}}(e.texture,e.alphaIndex);return{passes:o,wireframe:i,texture:l.colors,textureIndices:l.indices}}function c(t,e,r){return t+(e-t)*r}function u(t){for(let n=0;n<t.length;n++){const o=t[n],i=t[(n+1)%t.length],a=t[(n+2)%t.length],s=[o[0]-i[0],o[1]-i[1],o[2]-i[2]],l=[i[0]-a[0],i[1]-a[1],i[2]-a[2]],c=(r=s,[(e=l)[1]*r[2]-e[2]*r[1],e[2]*r[0]-e[0]*r[2],e[0]*r[1]-e[1]*r[0]]),u=f(c);if(u>0)return[c[0]/u,c[1]/u,c[2]/u]}var e,r;return[1,0,0]}function f(t){return Math.hypot(t[0],t[1],t[2])}class h{constructor(t,e,r){this.gl=t;const n=this.createShader(t.VERTEX_SHADER,e),o=this.createShader(t.FRAGMENT_SHADER,r);if(this.program=t.createProgram(),t.attachShader(this.program,n),t.attachShader(this.program,o),t.linkProgram(this.program),t.deleteShader(n),t.deleteShader(o),!t.getProgramParameter(this.program,t.LINK_STATUS)){const e=t.getProgramInfoLog(this.program);throw t.deleteProgram(this.program),Error("program compilation failed: "+e)}this.vertexLocation=this.getAttribLocation("vertex")}createShader(t,e){const r=this.gl,n=r.createShader(t);if(r.shaderSource(n,e),r.compileShader(n),!r.getShaderParameter(n,r.COMPILE_STATUS)){const e=r.getShaderInfoLog(n);throw r.deleteShader(n),Error(`${t===r.FRAGMENT_SHADER?"fragment":"vertex"} shader compilation failed: ${e}`)}return n}getAttribLocation(t){return this.gl.getAttribLocation(this.program,t)}getUniformLocation(t){return this.gl.getUniformLocation(this.program,t)}use(){this.gl.useProgram(this.program)}free(){this.gl.deleteProgram(this.program)}}function d(t,e,n){const o=new ImageData(t,e),i=o.data,a=t*e;let s=0;for(let t=0;t<a;t++){const e=r[parseInt(n.charAt(t),16)];i[s]=e[0],i[s+1]=e[1],i[s+2]=e[2],i[s+3]=255,s+=4}return o}const m=navigator.userAgent,g=m.includes("Safari/")&&!m.includes("Edg/");function p(t){return function(t){let e=0;return n();function r(){const r=t.charAt(e);if("{"===r)return n();if("'"===r)return o();if("-"===r||"."===r||r>="0"&&r<="9")return i();throw Error("Unkown value ("+e+'): "'+r+'" = '+r.charCodeAt(0))}function n(){e++;const n={array:[],dict:Object.create(null)};for(a();;){const o=t.charAt(e);if("}"===o){e++;break}let i;if(o>="a"&&o<="z"){let r=e;for(e++;;){if("="===t.charAt(e))break;e++}i=t.slice(r,e),e++}const s=r();null==i?n.array.push(s):n.dict[i]=s,a();","===t.charAt(e)&&(e++,a())}return n}function o(){const r=e,n=t.indexOf("'",e+1);if(n<0)throw Error("No end!!!");if(e=n+1,e===r)throw Error("!!!!");return t.slice(r+1,n)}function i(){const r=e;for(;;){const r=t.charAt(e);if(!("-"===r||"."===r||r>="0"&&r<="9"))break;e++}if(e===r)throw Error("!!!!");return Number(t.slice(r,e))}function a(){for(;;){const r=t.charAt(e);if(" "!==r&&"\n"!==r&&"\r"!==r&&"\t"!==r)break;e++}}}(t)}function x(t){let e=0,r=t.length;for(;e<t.length;){const n=t.charAt(e);if(e++,"\n"===n){r=e-1;break}if("\r"===n){r=e-1,"\n"===t.charAt(e)&&e++;break}}return[t.slice(0,r),t.slice(e)]}function v(t){if(!t.startsWith("picocad;"))throw Error("Not a picoCAD file.");const[e,r]=x(t),a=e.split(";"),s=a[1],[l,c,u]=a.slice(2).map((t=>Number(t))),[f,h]=function(t,e){const r=t.indexOf(e);return r<0?[t,""]:[t.slice(0,r),t.slice(r+e.length)]}(r,"%"),d=p(f),m=d.array.map((t=>{const e=t.dict.name,r=t.dict.pos.array,n=t.dict.rot.array,a=t.dict.v.array.map((t=>t.array)),s=t.dict.f.array.map((t=>{const e=t.array.map((t=>t-1)),r=t.dict.c,n=t.dict.uv.array,o=[];for(let t=1;t<n.length;t+=2)o.push([n[t-1],n[t]]);return new i(e,r,o,{shading:1!==t.dict.noshade,texture:1!==t.dict.notex,doubleSided:1===t.dict.dbl,renderFirst:1===t.dict.prio})}));return new o(e,r,n,a,s)}));const g=function(t){const e=Array(15360);let r,n=0;for(let o=0;o<120;o++){[r,t]=x(t);for(let t=0;t<128;t++)e[n]=Number.parseInt(r.charAt(t),16),n++}return e}(x(h)[1]);return new n(m,{name:s,alphaIndex:u,backgroundIndex:c,zoomLevel:l,texture:g})}
/*
   * @license
   * Adapted from lzwCompress.js
   *
   * Copyright (c) 2012-2021 floydpink
   * Licensed under the MIT license.
   */
const _={};function T(t){const e=function(t){function e(t){t=t.toLowerCase();for(let e=0;e<t.length;e++){const r=y.indexOf(t.charAt(e));r>0&&s(r,6)}s(0,6)}function r(t){for(const e of t)n(e)}function n(t){const e=Math.round(64*t)/64;if(e>=-16&&e<=15.75&&Number.isInteger(4*e))c.push(192+4*e);else{const r=8192+64*e;if(r>=32768)throw Error(`can't encode float "${t}"`);c.push((65280&r)>>8),c.push(255&r)}}let o=0,i=0;function a(){i>0&&c.push(o),o=0,i=0}function s(t,e){for(let r=0;r<e;r++){l((t&1<<r)>>r)}}function l(t){o+=t<<i,i++,i>=8&&(c.push(o),i=0,o=0)}const c=[];if(c.push(1),e(t.name),s(t.zoomLevel,7),s(t.backgroundIndex,4),s(t.alphaIndex,4),a(),t.objects.length>=256)throw Error("Too many objects");c.push(t.objects.length);for(const n of t.objects){if(e(n.name),a(),r(n.position),n.vertices.length>=256)throw Error("Too many vertices on object");c.push(n.vertices.length);for(const t of n.vertices)r(t);const t=R(n.vertices.length-1);if(n.faces.length>=256)throw Error("Too many faces on object");c.push(n.faces.length);for(const e of n.faces){s(e.colorIndex,4),l(e.texture?1:0),l(e.shading?1:0),l(e.doubleSided?1:0),l(e.renderFirst?1:0);for(const r of e.indices)s(r,t);if(s(e.indices[0],t),e.texture)for(const t of e.uvs)s(32+4*t[0],7),s(32+4*t[1],7)}a()}let u=t.texture.length-1;const f=t.texture[u];for(;u>=1&&t.texture[u-1]===f;)u--;const h=[];for(let e=0;e<=u;){const r=t.texture[e];let n=0;for(e++;e<=u&&t.texture[e]===r&&(e++,n++,15!=n););h.push((r<<4)+n)}if(h.length<u/2){c.push(0);for(const t of h)c.push(t)}else{c.push(1),u%2==0&&u++;for(let e=1;e<=u;e+=2)c.push((t.texture[e-1]<<4)+t.texture[e])}return c}(t);console.log("binary: "+e.length+" bytes");const r=function(t){const e=[];let r=0,n=0,o=512,i=9;for(let a=0;a<t.length;a++){256+a>=o&&(i++,o*=2);const s=t[a];for(let t=0;t<i;t++){r+=(s&1<<t)>>t<<n,n++,n>=8&&(e.push(r),n=0,r=0)}}n>0&&e.push(r);return e}(function(t){if(!t||!0===t||t instanceof Date)return t;let e=t;return"object"==typeof t&&(e=_.KeyOptimize.pack(JSON.stringify(t))),_.LZWCompress.pack(e)}(A(e)));let n=btoa(A(r)),o=n.indexOf("=",n.length-4);return o>=0&&(n=n.slice(0,o)),n}function E(t){const e=function(t){const e=[];let r=0,n=0,o=512,i=9;for(let a=0;a<t.length;a++){const s=t[a];for(let t=0;t<8;t++){r+=(s&1<<t)>>t<<n,n++,n>=i&&(e.push(r),n=0,r=0,256+e.length>=o&&(i++,o*=2))}}return e}(b(atob(t)));return function(t){function e(){let t="";for(;;){const e=f(6);if(0===e)break;if(e>=y.length)throw Error("invalid encoded string");t+=y.charAt(e)}return t}function r(){if(h<t.length)return t[h++];throw Error("unexpected of input")}function a(){return h<t.length?t[h++]:-1}function s(){const t=r();if(t>=128)return((127&t)-64)/4;return((t<<8)+r()-8192)/64}function l(t){const e=Array(t);for(let r=0;r<t;r++)e[r]=s();return e}let c=0;function u(){c>0&&(h++,c=0)}function f(e){let r=t[h],n=0;for(let o=0;o<e;o++){if(n+=(r&1<<c)>>c<<o,c++,c>=8){if(c=0,h++,h>=t.length)throw Error("Unexpected end of input");r=t[h]}}return n}let h=0;const d=r();if(1!==d)throw Error(`invalid encoding version ${d}`);const m=e(),g=f(7),p=f(4),x=f(4);u();const v=r(),_=Array(v);for(let t=0;t<v;t++){const n=e();u();const a=l(3),s=r(),c=Array(s);for(let t=0;t<s;t++)c[t]=l(3);const h=R(s-1),d=r(),m=Array(d);for(let t=0;t<d;t++){const e=f(4),r=1===f(1),n=1===f(1),o=1===f(1),a=1===f(1),s=f(h),l=[s];for(;;){const t=f(h);if(t===s)break;l.push(t)}const c=l.length;let u=Array(c);if(r)for(let t=0;t<c;t++){const e=f(7),r=f(7);u[t]=[(e-32)/4,(r-32)/4]}else for(let t=0;t<c;t++)u[t]=[0,0];m[t]=new i(l,e,u,{texture:r,shading:n,doubleSided:o,renderFirst:a})}u(),_[t]=new o(n,a,[0,0,0],c,m)}const T=r();let E=[];if(0===T)for(let t=0;t<=15360;){const t=a();if(t<0)break;const e=(240&t)>>4,r=1+(15&t);for(let t=0;t<r;t++)E.push(e)}else{if(1!==T)throw Error(`Invalid texture encoding code: ${T}`);for(let t=0;t<7680;t++){const t=a();if(t<0)break;E.push((240&t)>>4,15&t)}}if(E.length<15360){const t=E[E.length-1];for(;E.length<15360;)E.push(t)}return new n(_,{name:m,alphaIndex:x,backgroundIndex:p,zoomLevel:g,texture:E})}(b(function(t){if(!t||!0===t||t instanceof Date)return t;let e,r=_.LZWCompress.unpack(t);try{e=JSON.parse(r)}catch(t){return r}return"object"==typeof e&&(r=_.KeyOptimize.unpack(e)),r}(e)))}function A(t){let e="";for(const r of t)e+=String.fromCharCode(r);return e}function b(t){const e=Array(t.length);for(let r=0;r<t.length;r++)e[r]=t.charCodeAt(r);return e}!function(t){let e=[];const r=function(t){return function(e){return e===t}},n=function(t,e,r){(function(t,e){for(let r=0;r<t.length;r++)if(e(t[r]))return!0;return!1})(t,r)||t.push(e)},o=function(t){if("object"==typeof t)for(let i in t)Array.isArray(t)||n(e,i,r(i)),o(t[i])},i=function(t){if("object"!=typeof t)return t;for(let r in t)Array.isArray(t)?t[r]=i(t[r]):t.hasOwnProperty(r)&&(t[e.indexOf(r)]=i(t[r]),delete t[r]);return t},a=function(t){if("object"!=typeof t)return t;for(let r in t)Array.isArray(t)?t[r]=a(t[r]):t.hasOwnProperty(r)&&e[r]&&(t[e[r]]=a(t[r]),delete t[r]);return t};t.KeyOptimize={pack:function(t){e=[];const r=JSON.parse(t);return o(r),JSON.stringify({__k:e,__v:i(r)})},unpack:function(t){const r=t;return"object"!=typeof r?t:r.hasOwnProperty("__k")?(e=r.__k,a(r.__v)):JSON.stringify(r)}}}(_),_.LZWCompress={pack:function(t){if("string"!=typeof t)return t;let e;const r=Object.create(null);let n,o,i="";const a=[];let s=256;for(e=0;e<256;e+=1)r[String.fromCharCode(e)]=e;for(e=0;e<t.length;e+=1)if(n=t.charAt(e),o=i+n,r[o])i=o;else{if(void 0===r[i])return t;a.push(r[i]),r[o]=s++,i=String(n)}return""!==i&&a.push(r[i]),a},unpack:function(t){if(!Array.isArray(t))return t;let e;const r=[];let n,o,i,a="",s=256;for(e=0;e<256;e+=1)r[e]=String.fromCharCode(e);for(n=String.fromCharCode(t[0]),o=n,e=1;e<t.length;e+=1){if(i=t[e],r[i])a=r[i];else{if(i!==s)return null;a=n+n.charAt(0)}o+=a,r[s++]=n+a.charAt(0),n=a}return o}};const y="\0abcdefghijklmnopqrstuvwxyz0123456789_ ";function R(t){return Math.floor(Math.log2(t)+1)}const w=document.getElementById("texture"),B=document.getElementById("viewport"),F=document.getElementById("input-resolution"),D=document.getElementById("input-auto-turn"),U=document.getElementById("input-wireframe"),L=document.getElementById("input-wireframe-color"),M=document.getElementById("input-render-mode"),C=document.getElementById("input-shading"),I=document.getElementById("input-fov"),S=document.getElementById("btn-show-controls"),P=document.getElementById("popup-controls"),k=document.getElementById("stats"),N=new class{constructor(t={}){this.canvas=t.canvas,null==this.canvas&&(this.canvas=document.createElement("canvas"));const e=this.gl=this.canvas.getContext("webgl",{antialias:!1});if(this.cameraPosition={x:0,y:0,z:0},this.cameraRotation={x:0,y:0,z:0},this.cameraFOV=t.fov??90,this.loaded=!1,this.model=null,this.modelTexture=null,this.shading=t.shading??!0,this.renderMode=t.renderMode??"texture",this.drawWireframe=t.drawWireframe??!1,this.wireframeXray=t.wireframeXray??!0,this.wireframeColor=t.wireframeColor??[1,1,1],this.tesselationCount=t.tesselationCount??3,this.lightDirection=t.lightDirection??{x:1,y:-1,z:0},this._passes=[],this._mainTex=null,this._indexTex=null,this._lightMapTex=this._createTexture(null,e.RGB,e.RGB,e.UNSIGNED_BYTE,d(32,4,"00112233445566778899aabbccddeeff0010213542516d768294a9b3cdd5e8fe000011552211dd6622449933dd55889900000011110055dd1122445555112244")),this._colorLightMapTex=this._createTexture(null,e.RGB,e.RGB,e.UNSIGNED_BYTE,d(32,7,"00112233445566778899aabbccddeeff0011223542556d768894a9bbccddeefe001122552255dd66884499bbccddeeee001021512251d56d824294b3cdd5e8e800001111221155dd22224433dd55888800001010211151d521224235d551828200000000111111551122225555112222")),this._programTexture=function(t){const e=new h(t,"\n\t\tattribute vec4 vertex;\n\t\tattribute vec3 normal;\n\t\tattribute vec2 uv;\n\n\t\tvarying highp vec2 v_uv;\n\t\tvarying highp vec3 v_normal;\n\n\t\tuniform mat4 mvp;\n\n\t\tvoid main() {\n\t\t\tv_normal = normal;\n\t\t\tv_uv = uv;\n\t\t\tgl_Position = mvp * vertex;\n\t\t}\n\t","\n\t\tvarying highp vec2 v_uv;\n\t\tvarying highp vec3 v_normal;\n\t\t\n\t\tuniform sampler2D indexTex;\n\t\tuniform sampler2D lightMap;\n\t\tuniform highp vec3 lightDir;\n\t\tuniform highp float lightMapOffset;\n\t\tuniform highp float lightMapGradient;\n\n\t\tvoid main() {\n\t\t\thighp float index = texture2D(indexTex, v_uv).r;\n\t\t\tif (index == 1.0) discard;\n\t\t\t// highp float intensity = clamp(4.0 * abs(dot(v_normal, lightDir)) - 1.0, 0.0, 1.0);\n\t\t\thighp float intensity = clamp(lightMapGradient * abs(dot(v_normal, lightDir)) + lightMapOffset, 0.0, 1.0);\n\t\t\tgl_FragColor = texture2D(lightMap, vec2(index * 15.9375 + mod(gl_FragCoord.x + gl_FragCoord.y, 2.0) * 0.03125, 1.0 - intensity));\n\t\t}\n\t");return{program:e,locations:{uv:e.getAttribLocation("uv"),normal:e.getAttribLocation("normal"),indexTex:e.getUniformLocation("indexTex"),lightMap:e.getUniformLocation("lightMap"),lightDir:e.getUniformLocation("lightDir"),mvp:e.getUniformLocation("mvp"),lightMapOffset:e.getUniformLocation("lightMapOffset"),lightMapGradient:e.getUniformLocation("lightMapGradient")}}}(e),this._programUnlitTexture=function(t){const e=new h(t,"\n\t\tattribute vec4 vertex;\n\t\tattribute vec2 uv;\n\n\t\tvarying highp vec2 v_uv;\n\n\t\tuniform mat4 mvp;\n\n\t\tvoid main() {\n\t\t\tv_uv = uv;\n\t\t\tgl_Position = mvp * vertex;\n\t\t}\n\t","\n\t\tvarying highp vec2 v_uv;\n\t\t\n\t\tuniform sampler2D mainTex;\n\n\t\tvoid main() {\n\t\t\tlowp vec4 color = texture2D(mainTex, v_uv);\n\t\t\tif (color.a == 0.0) discard;\n\t\t\tgl_FragColor = color;\n\t\t}\n\t");return{program:e,locations:{uv:e.getAttribLocation("uv"),mvp:e.getUniformLocation("mvp"),mainTex:e.getUniformLocation("mainTex")}}}(e),this._wireframe=null,this._programWireframe=function(t){const e=new h(t,"\n\t\tattribute vec4 vertex;\n\n\t\tuniform mat4 mvp;\n\n\t\tvoid main() {\n\t\t\tgl_Position = mvp * vertex;\n\t\t}\n\t","\n\t\tuniform lowp vec4 color;\n\n\t\tvoid main() {\n\t\t\tgl_FragColor = color;\n\t\t}\n\t");return{program:e,locations:{mvp:e.getUniformLocation("mvp"),color:e.getUniformLocation("color")}}}(e),g)this._programFramebuffer=function(t){const e=new h(t,"\n\t\tattribute vec4 vertex;\n\n\t\tvarying highp vec2 v_uv;\n\n\t\tvoid main() {\n\t\t\tv_uv = 0.5 + vertex.xy * 0.5;\n\t\t\tgl_Position = vertex;\n\t\t}\n\t","\n\t\tvarying highp vec2 v_uv;\n\t\t\n\t\tuniform sampler2D mainTex;\n\n\t\tvoid main() {\n\t\t\tgl_FragColor = texture2D(mainTex, v_uv);\n\t\t}\n\t");return{program:e,locations:{mainTex:e.getUniformLocation("mainTex")}}}(e),this._depthBuffer=e.createRenderbuffer(),this._frameBuffer=e.createFramebuffer(),this._screenQuads=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._screenQuads),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),e.STATIC_DRAW);else{const t="pico-cad-viewport";this.canvas.classList.add(t),this._style=document.createElement("style"),this._style.textContent=`.${t} { image-rendering: -moz-crisp-edges; image-rendering: pixelated; }`,document.head.append(this._style)}const r=t.resolution;null==r?this.setResolution(128,128,1):this.setResolution(r.width,r.height,r.scale??1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL)}setResolution(t,e,r=1){if(null!=this._resolution&&this._resolution[0]===t&&this._resolution[1]===e&&this._resolution[2]===r)return;this._resolution=[t,e,r,0,0];const n=t*r,o=e*r,i=this.gl,a=this.canvas;g?(a.width=n,a.height=o,this._frameBufferTex=this._createTexture(this._frameBufferTex,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,null,t,e),i.bindRenderbuffer(i.RENDERBUFFER,this._depthBuffer),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,t,e),i.bindFramebuffer(i.FRAMEBUFFER,this._frameBuffer),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this._frameBufferTex,0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,this._depthBuffer)):(a.width=t,a.height=e),a.style.width=`${n}px`,a.style.height=`${o}px`}getResolution(){return{width:this._resolution[0],height:this._resolution[1],scale:this._resolution[2]}}_createTexture(t,e,r,n,o,i,a){const s=this.gl;return null==t&&(t=s.createTexture()),s.bindTexture(s.TEXTURE_2D,t),null==i?s.texImage2D(s.TEXTURE_2D,0,e,r,n,o):s.texImage2D(s.TEXTURE_2D,0,e,i,a,0,r,n,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),t}async load(t){if("string"==typeof t)t.startsWith("picocad;")?this._loadString(t):await this._loadUrl(t);else if(t instanceof URL)await this._loadUrl(t);else if(t instanceof Blob)await this._loadBlob(t);else{if(!(t instanceof n))throw TypeError();this._loadModel(t)}return this.model}async _loadUrl(t){const e=await fetch(String(t));if(!e.ok)throw Error(`${e.status}: ${e.statusText}`);this._loadString(await e.text())}_loadBlob(t){return new Promise(((e,r)=>{if(!t.type.startsWith("text"))throw Error("picoCAD file must be a text file");const n=new FileReader;n.onload=()=>{e(this._loadString(n.result))},n.onerror=()=>{r(n.error)},n.readAsText(t)}))}_loadString(t){this._loadModel(v(t))}_loadModel(t){const e=this.gl;if(this.loaded=!1,this.model=null,this.loaded){for(const t of this._passes)t.free();this._passes=[],this._wireframe.free(),e.deleteTexture(this._mainTex),this._mainTex=null,e.deleteTexture(this._indexTex),this._indexTex=null}const r=l(e,t,this.tesselationCount);this._passes=r.passes,this._wireframe=r.wireframe,this._mainTex=this._createTexture(this._mainTex,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r.texture),this._indexTex=this._createTexture(this._indexTex,e.LUMINANCE,e.LUMINANCE,e.UNSIGNED_BYTE,new Uint8Array(r.textureIndices),128,128),this.modelTexture=r.texture,this.loaded=!0,this.model=t}draw(){const e="none"!==this.renderMode,r="color"===this.renderMode;if(!this.loaded||!e&&!this.drawWireframe)return;const n=this.gl,o=this.canvas;g?(n.bindFramebuffer(n.FRAMEBUFFER,this._frameBuffer),n.viewport(0,0,this._resolution[0],this._resolution[1])):n.viewport(0,0,o.width,o.height);const i=this.model.backgroundColor();n.clearColor(i[0]/255,i[1]/255,i[2]/255,1),n.clearDepth(1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);const a=(s=new t(16),t!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=0,s[12]=0,s[13]=0,s[14]=0),s[0]=1,s[5]=1,s[10]=1,s[15]=1,s);var s;!function(t,e,r,n,o){var i,a=1/Math.tan(e/2);t[0]=a/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=o&&o!==1/0?(i=1/(n-o),t[10]=(o+n)*i,t[14]=2*o*n*i):(t[10]=-1,t[14]=-2*n)}(a,this.cameraFOV*Math.PI/180,this._resolution[0]/this._resolution[1],.1,400),function(t,e,r){var n=Math.sin(r),o=Math.cos(r),i=e[4],a=e[5],s=e[6],l=e[7],c=e[8],u=e[9],f=e[10],h=e[11];e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=i*o+c*n,t[5]=a*o+u*n,t[6]=s*o+f*n,t[7]=l*o+h*n,t[8]=c*o-i*n,t[9]=u*o-a*n,t[10]=f*o-s*n,t[11]=h*o-l*n}(a,a,this.cameraRotation.x),function(t,e,r){var n=Math.sin(r),o=Math.cos(r),i=e[0],a=e[1],s=e[2],l=e[3],c=e[8],u=e[9],f=e[10],h=e[11];e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=i*o-c*n,t[1]=a*o-u*n,t[2]=s*o-f*n,t[3]=l*o-h*n,t[8]=i*n+c*o,t[9]=a*n+u*o,t[10]=s*n+f*o,t[11]=l*n+h*o}(a,a,this.cameraRotation.y),function(t,e,r){var n=Math.sin(r),o=Math.cos(r),i=e[0],a=e[1],s=e[2],l=e[3],c=e[4],u=e[5],f=e[6],h=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=i*o+c*n,t[1]=a*o+u*n,t[2]=s*o+f*n,t[3]=l*o+h*n,t[4]=c*o-i*n,t[5]=u*o-a*n,t[6]=f*o-s*n,t[7]=h*o-l*n}(a,a,this.cameraRotation.z),function(t,e,r){var n,o,i,a,s,l,c,u,f,h,d,m,g=r[0],p=r[1],x=r[2];e===t?(t[12]=e[0]*g+e[4]*p+e[8]*x+e[12],t[13]=e[1]*g+e[5]*p+e[9]*x+e[13],t[14]=e[2]*g+e[6]*p+e[10]*x+e[14],t[15]=e[3]*g+e[7]*p+e[11]*x+e[15]):(n=e[0],o=e[1],i=e[2],a=e[3],s=e[4],l=e[5],c=e[6],u=e[7],f=e[8],h=e[9],d=e[10],m=e[11],t[0]=n,t[1]=o,t[2]=i,t[3]=a,t[4]=s,t[5]=l,t[6]=c,t[7]=u,t[8]=f,t[9]=h,t[10]=d,t[11]=m,t[12]=n*g+s*p+f*x+e[12],t[13]=o*g+l*p+h*x+e[13],t[14]=i*g+c*p+d*x+e[14],t[15]=a*g+u*p+m*x+e[15])}(a,a,[this.cameraPosition.x,this.cameraPosition.y,this.cameraPosition.z]);const l=function(t){let e=Math.hypot(t.x,t.y,t.z);0===e&&(e=1);return{x:t.x/e,y:t.y/e,z:t.z/e}}(this.lightDirection);if(e)for(const t of this._passes){if(t.clearDepth&&n.clear(n.DEPTH_BUFFER_BIT),t.isEmpty())continue;const e=r||!t.texture,o=this.shading&&t.shading?this._programTexture:this._programUnlitTexture;o.program.use(),n.uniformMatrix4fv(o.locations.mvp,!1,a),n.bindBuffer(n.ARRAY_BUFFER,t.vertexBuffer),n.vertexAttribPointer(o.program.vertexLocation,3,n.FLOAT,!1,0,0),n.enableVertexAttribArray(o.program.vertexLocation),n.bindBuffer(n.ARRAY_BUFFER,e?t.colorUVBuffer:t.uvBuffer),n.vertexAttribPointer(o.locations.uv,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(o.locations.uv),o===this._programUnlitTexture?(n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._mainTex),n.uniform1i(o.locations.mainTex,0)):o===this._programTexture&&(n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._indexTex),n.uniform1i(o.locations.indexTex,0),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,e?this._colorLightMapTex:this._lightMapTex),n.uniform1i(o.locations.lightMap,1),n.uniform1f(o.locations.lightMapOffset,e?-.316326530612245:-.3571428571428572),n.uniform1f(o.locations.lightMapGradient,e?1.63265306122449:2.857142857142857),n.uniform3f(o.locations.lightDir,l.x,l.y,l.z),n.bindBuffer(n.ARRAY_BUFFER,t.normalBuffer),n.vertexAttribPointer(o.locations.normal,3,n.FLOAT,!1,0,0),n.enableVertexAttribArray(o.locations.normal)),t.cull?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.triangleBuffer),n.drawElements(n.TRIANGLES,t.vertexCount,n.UNSIGNED_SHORT,0),n.disableVertexAttribArray(o.program.vertexLocation),n.disableVertexAttribArray(o.locations.uv),o===this._programTexture&&n.disableVertexAttribArray(o.locations.normal)}this.drawWireframe&&(e&&this.wireframeXray&&n.clear(n.DEPTH_BUFFER_BIT),this._programWireframe.program.use(),n.uniformMatrix4fv(this._programWireframe.locations.mvp,!1,a),n.uniform4fv(this._programWireframe.locations.color,[this.wireframeColor[0],this.wireframeColor[1],this.wireframeColor[2],1]),n.bindBuffer(n.ARRAY_BUFFER,this._wireframe.vertexBuffer),n.vertexAttribPointer(this._programWireframe.program.vertexLocation,3,n.FLOAT,!1,0,0),n.enableVertexAttribArray(this._programWireframe.program.vertexLocation),n.drawArrays(n.LINES,0,this._wireframe.vertexCount)),g&&(n.bindFramebuffer(n.FRAMEBUFFER,null),n.viewport(0,0,o.width,o.height),this._programFramebuffer.program.use(),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._frameBufferTex),n.uniform1i(this._programFramebuffer.locations.mainTex,0),n.bindBuffer(n.ARRAY_BUFFER,this._screenQuads),n.vertexAttribPointer(this._programFramebuffer.program.vertexLocation,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(this._programFramebuffer.program.vertexLocation),n.drawArrays(n.TRIANGLES,0,6))}startDrawLoop(t){let e=performance.now();const r=()=>{if(null!=t){const r=performance.now();t((r-e)/1e3),e=r}this.draw(),this._rafID=requestAnimationFrame(r)};r()}stopDrawLoop(){null!=this._rafID&&cancelAnimationFrame(this._rafID)}getCameraRight(){return this._transformDirection(1,0,0)}getCameraUp(){return this._transformDirection(0,-1,0)}getCameraForward(){return this._transformDirection(0,0,-1)}setLightDirectionFromCamera(){const t=this.getCameraUp(),e=this.getCameraForward();this.lightDirection={x:e.x-.4*t.x,y:e.y-.4*t.y,z:e.z-.4*t.z}}getTextureColorCount(t=!1){const e=Array(16).fill(!1);let r=0;for(const t of this.model.texture)e[t]||(e[t]=!0,r++);return r}getTriangleCount(){let t=0;for(const e of this._passes)t+=Math.floor(e.vertexCount/3);return t}getDrawCallCount(){let t=0;for(const e of this._passes)e.isEmpty()||t++;return this.drawWireframe&&t++,g&&t++,t}_transformDirection(t,r,n){const o=e();!function(t,e,r,n){t[0]=e,t[1]=r,t[2]=n}(o,t,r,n);const i=((a=e())[0]=0,a[1]=0,a[2]=0,a);var a;return function(t,e,r,n){var o=[],i=[];o[0]=e[0]-r[0],o[1]=e[1]-r[1],o[2]=e[2]-r[2],i[0]=o[0],i[1]=o[1]*Math.cos(n)-o[2]*Math.sin(n),i[2]=o[1]*Math.sin(n)+o[2]*Math.cos(n),t[0]=i[0]+r[0],t[1]=i[1]+r[1],t[2]=i[2]+r[2]}(o,o,i,Math.PI+this.cameraRotation.x),function(t,e,r,n){var o=[],i=[];o[0]=e[0]-r[0],o[1]=e[1]-r[1],o[2]=e[2]-r[2],i[0]=o[2]*Math.sin(n)+o[0]*Math.cos(n),i[1]=o[1],i[2]=o[2]*Math.cos(n)-o[0]*Math.sin(n),t[0]=i[0]+r[0],t[1]=i[1]+r[1],t[2]=i[2]+r[2]}(o,o,i,this.cameraRotation.y),function(t,e,r,n){var o=[],i=[];o[0]=e[0]-r[0],o[1]=e[1]-r[1],o[2]=e[2]-r[2],i[0]=o[0]*Math.cos(n)-o[1]*Math.sin(n),i[1]=o[0]*Math.sin(n)+o[1]*Math.cos(n),i[2]=o[2],t[0]=i[0]+r[0],t[1]=i[1]+r[1],t[2]=i[2]+r[2]}(o,o,i,Math.PI+this.cameraRotation.z),{x:o[0],y:o[1],z:o[2]}}setTurntableCamera(t,e,r,n={x:0,y:1.5,z:0}){const o=Math.PI-e;r=-r,this.cameraPosition={x:t*Math.cos(r)*Math.sin(o)-n.x,y:t*Math.sin(r)-n.y,z:t*Math.cos(r)*Math.cos(o)-n.z},this.cameraRotation={y:e,x:-r,z:0}}free(){const t=this.gl;this.stopDrawLoop();for(const t of this._passes)t.free();this._passes=[],t.deleteTexture(this._lightMapTex),t.deleteTexture(this._colorLightMapTex),t.deleteTexture(this._mainTex),t.deleteTexture(this._indexTex),this._lightMapTex=null,this._colorLightMapTex=null,this._mainTex=null,this._indexTex=null,this._programTexture.program.free(),this._programWireframe.program.free(),this._programTexture=null,this._programWireframe=null,g&&(t.deleteFramebuffer(this._frameBuffer),t.deleteTexture(this._frameBufferTex),t.deleteBuffer(this._screenQuads),t.deleteRenderbuffer(this._depthBuffer),this._programFramebuffer.program.free(),this._frameBuffer=null,this._frameBufferTex=null,this._screenQuads=null,this._depthBuffer=null,this._programFramebuffer=null)}}({canvas:B});window.viewer=N;let O=-Math.PI/2,z=.2,W=12,Y=.75,X={x:0,y:1.5,z:0},G=!0,j=0;async function V(t,e=!0){const r=await N.load(t);window.model=r,console.log(`=== load "${r.name}" ===`),B.classList.add("loaded"),W=r.zoomLevel,H.putImageData(N.modelTexture,0,0);const n=r.objects.reduce(((t,e)=>t+e.faces.length),0);for(;null!=k.lastChild;)k.lastChild.remove();k.append(ct("li",{},N.model.name));const o={Colors:N.getTextureColorCount(),Objects:r.objects.length,Faces:n};console.log(`${N.getTriangleCount()} triangles, ${N.getDrawCallCount()} draw calls`);for(const[t,e]of Object.entries(o))k.append(ct("li",{},`${t}: ${e}`));if(e){const t=T(r);history.pushState(null,"","#"+t),console.log(`lzw base64: ${t.length} bytes`)}}function $(t=!0){V("./example.txt",t)}const H=w.getContext("2d");function K(t){"r"===t?nt(!N.drawWireframe):"t"===t?ot(!G):"m"===t?it("texture"===M.value?"color":"texture"):"l"===t?at(!C.checked):"/"!==t&&"?"!==t||$()}document.querySelectorAll(".popup").forEach((t=>{t.addEventListener("click",(()=>{P.hidden=!P.hidden}))})),S.onclick=()=>{P.hidden=!P.hidden},P.querySelectorAll("kbd").forEach((t=>{t.onclick=()=>K(t.textContent.toLowerCase())}));const q=Object.create(null);window.onkeydown=t=>{if(!t.ctrlKey&&!t.metaKey){t.preventDefault();const e=t.key.toLowerCase();q[e]=!0,K(e)}},window.onkeyup=t=>{t.ctrlKey||t.metaKey||(t.preventDefault(),q[t.key.toLowerCase()]=!1)},B.ondblclick=()=>{N.loaded&&B.requestPointerLock()},B.oncontextmenu=t=>{t.preventDefault()},document.onpointerlockchange=t=>{j=document.pointerLockElement===B?1:0};let Q=Array(5).fill(!1),J=Array(5).fill(!1),Z=[0,0];window.onmousedown=t=>{const e=t.button,r=t.target==B;Q[e]=!0,J[e]=r,r&&(t.preventDefault(),B.classList.add("grabbing"),0===j&&0===e&&ot(!1))},window.onmouseup=t=>{const e=t.button;Q[e]=!1,J[e]=!1,B.classList.remove("grabbing")},window.onmousemove=t=>{const e=[t.clientX,t.clientY],r=[e[0]-Z[0],e[1]-Z[1]];if(1===j&&document.pointerLockElement===B){const e=.003;O+=t.movementX*e,z+=t.movementY*e}else if(0==j)if(J[0]){const t=.005;O+=r[0]*t,z+=r[1]*t}else if(J[1]||J[2]){const t=.005,e=N.getCameraUp(),n=N.getCameraRight(),o=r[0]*t,i=-r[1]*t;X.x+=n.x*o+e.x*i,X.y+=n.y*o+e.y*i,X.z+=n.z*o+e.z*i}Z=e},B.onwheel=t=>{t.preventDefault();const e=lt(-6,6,t.deltaY);1===j||0===j&&t.altKey?rt(N.cameraFOV+e):0===j&&(W=lt(0,200,W+.5*e))};let tt=[0,0,-1],et=!1;document.addEventListener("touchstart",(t=>{et=t.target==B;const e=t.changedTouches[0];tt=[e.clientX,e.clientY,e.identifier],et&&(t.preventDefault(),ot(!1))}),{passive:!1}),document.addEventListener("touchmove",(t=>{const e=Array.from(t.changedTouches).find((t=>t.identifier===tt[2]));if(null!=e){const t=[e.clientX,e.clientY,e.identifier];if(et){const e=[t[0]-tt[0],t[1]-tt[1]],r=.01;O+=e[0]*r,z+=e[1]*r}tt=t}})),document.addEventListener("touchend",(t=>{null!=Array.from(t.changedTouches).find((t=>t.identifier===tt[2]))&&(et=!1)})),window.innerWidth<700&&(F.value="128,128,2"),ut(F,(t=>{const[e,r,n]=t.split(",").map((t=>Number(t)));N.setResolution(e,r,n)}));const rt=ut(I,(()=>{N.cameraFOV=I.valueAsNumber,I.nextElementSibling.textContent=I.value})),nt=ut(U,(()=>{N.drawWireframe=U.checked})),ot=ut(D,(()=>{G=D.checked}));ut(L,(t=>{N.wireframeColor=[t.slice(1,3),t.slice(3,5),t.slice(5,7)].map((t=>parseInt(t,16)/255))}));const it=ut(M,(t=>{N.renderMode=t})),at=ut(C,(()=>{N.shading=C.checked}));function st(){document.body.classList.remove("drag")}function lt(t,e,r){return r<t?t:r>e?e:r}function ct(t,e,...r){if(t=t instanceof Element?t:document.createElement(t),null!=e)for(const r in e)t.setAttribute(r,e[r]);return t.append(...r),t}function ut(t,e){function r(){e(t.value,!1)}return t[t instanceof HTMLSelectElement?"onchange":"oninput"]=r,e(t.value,!0),t instanceof HTMLInputElement?e=>{"boolean"==typeof e?t.checked=e:t.value=e,r()}:e=>{t.value=e,r()}}function ft(){if(location.hash.length>1)return V(E(location.hash.slice(1)),!1),!0}N.startDrawLoop((t=>{const e=1.2*t;let r=0,n=0,o=0,i=0,a=0;if(q.w&&(n+=1),q.s&&(n-=1),q.a&&(r-=1),q.d&&(r+=1),(q.q||q.shift||q.control)&&(o-=1),(q.e||q[" "])&&(o+=1),q.arrowleft&&(i-=1),q.arrowright&&(i+=1),q.arrowup&&(a-=1),q.arrowdown&&(a+=1),0===j)z+=(n+a)*e,X.y+=3*o*t,G?(Y-=2*(r+i)*t,Y=lt(-2,2,Y),O+=Y*t):O+=(r+i)*e,N.setTurntableCamera(W,O,z,X);else if(1===j&&(O+=i*e,z+=a*e,z=lt(-Math.PI/2,Math.PI/2,z),N.cameraRotation.x=z,N.cameraRotation.y=O,0!==r||0!==o||0!==n)){const e=6*t,i=N.getCameraRight(),a=N.getCameraUp(),s=N.getCameraForward(),l=N.cameraPosition;l.x+=(i.x*r+s.x*n+a.x*o)*e,l.y+=(i.y*r+s.y*n+a.y*o)*e,l.z+=(i.z*r+s.z*n+a.z*o)*e}N.setLightDirectionFromCamera()})),window.addEventListener("dragover",(t=>{t.preventDefault()})),window.addEventListener("dragenter",(t=>{t.dataTransfer.types.includes("Files")&&document.body.classList.add("drag")})),window.addEventListener("dragexit",(t=>{st()})),window.addEventListener("drop",(t=>{t.preventDefault(),st();const e=t.dataTransfer.files[0];null!=e&&V(e)})),document.body.addEventListener("paste",(t=>{const e=t.clipboardData.getData("text/plain");if(null!=e)V(e);else{const e=t.clipboardData.files[0];null!=e&&V(e)}})),ft()||$(!1),onhashchange=t=>{ft()},window.loadModel=V}();
