!function(){"use strict";var t="undefined"!=typeof Float32Array?Float32Array:Array;function e(){var e=new t(3);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function r(t){return function(t){let e=0;return n();function r(){const r=t.charAt(e);if("{"===r)return n();if("'"===r)return a();if("-"===r||"."===r||r>="0"&&r<="9")return o();throw Error("Unkown value ("+e+'): "'+r+'" = '+r.charCodeAt(0))}function n(){e++;const n={array:[],dict:Object.create(null)};for(i();;){const a=t.charAt(e);if("}"===a){e++;break}let o;if(a>="a"&&a<="z"){let r=e;for(e++;;){if("="===t.charAt(e))break;e++}o=t.slice(r,e),e++}const s=r();null==o?n.array.push(s):n.dict[o]=s,i();","===t.charAt(e)&&(e++,i())}return n}function a(){const r=e,n=t.indexOf("'",e+1);if(n<0)throw Error("No end!!!");if(e=n+1,e===r)throw Error("!!!!");return t.slice(r+1,n)}function o(){const r=e;for(;;){const r=t.charAt(e);if(!("-"===r||"."===r||r>="0"&&r<="9"))break;e++}if(e===r)throw Error("!!!!");return Number(t.slice(r,e))}function i(){for(;;){const r=t.charAt(e);if(" "!==r&&"\n"!==r&&"\r"!==r&&"\t"!==r)break;e++}}}(t)}function n(t){let e=0,r=t.length;for(;e<t.length;){const n=t.charAt(e);if(e++,"\n"===n){r=e-1;break}if("\r"===n){r=e-1,"\n"===t.charAt(e)&&e++;break}}return[t.slice(0,r),t.slice(e)]}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),e();const a=[[0,0,0],[29,43,83],[126,37,83],[0,135,81],[171,82,54],[95,87,79],[194,195,199],[255,241,232],[255,0,77],[255,163,0],[255,236,39],[0,228,54],[41,173,255],[131,118,156],[255,119,168],[255,204,170]];class o{constructor(t,e={}){this.gl=t,this.cull=e.cull??!0,this.shading=e.shading??!0,this.texture=e.texture??!0,this.clearDepth=e.clearDepth??!1,this.vertices=[],this.normals=[],this.uvs=[],this.colorUVs=[],this.triangles=[]}save(){const t=this.gl;this.vertexCount=this.triangles.length,this.isEmpty()||(this.vertexBuffer=t.createBuffer(),this.uvBuffer=t.createBuffer(),this.colorUVBuffer=t.createBuffer(),this.triangleBuffer=t.createBuffer(),this.shading&&(this.normalBuffer=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.vertices),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.uvBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.uvs),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.colorUVBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.colorUVs),t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.triangleBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.triangles),t.STATIC_DRAW),this.shading&&(t.bindBuffer(t.ARRAY_BUFFER,this.normalBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.normals),t.STATIC_DRAW))),this.uvs=null,this.colorUVs=null,this.normals=null,this.vertices=null,this.triangles=null}isEmpty(){return 0===this.vertexCount}free(){const t=this.gl;t.deleteBuffer(this.vertexBuffer),t.deleteBuffer(this.uvBuffer),t.deleteBuffer(this.colorUVBuffer),t.deleteBuffer(this.triangleBuffer),this.shading&&t.deleteBuffer(this.normalBuffer)}}class i{constructor(t){this.gl=t,this.vertices=[]}save(){const t=this.gl;this.vertexCount=Math.floor(this.vertices.length/3),this.vertexBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.vertices),t.STATIC_DRAW),this.vertices=null}free(){this.gl.deleteBuffer(this.vertexBuffer)}}function s(t,e,s){if(!e.startsWith("picocad;"))throw Error("Not a picoCAD file.");const[h,u]=n(e),f=h.split(";"),d=f[1],[m,g,p]=f.slice(2).map((t=>Number(t))),[x,v]=function(t,e){const r=t.indexOf(e);return r<0?[t,""]:[t.slice(0,r),t.slice(r+e.length)]}(u,"%"),_=r(x),{passes:T,faceCount:E,objectCount:A,wireframe:w}=function(t,e,r){const n=[];for(let e=0;e<16;e++){const r=e%2<1,a=e%4<2,i=e%8<4;n.push(new o(t,{cull:r,shading:a,texture:i,clearDepth:8===e}))}const a=new i(t),s=a.vertices;let h=0;for(const t of e.array){const e=t.dict.pos.array,a=t.dict.v.array.map((t=>{const r=t.array;return[-r[0]-e[0],-r[1]-e[1],r[2]+e[2]]}));for(const e of t.dict.f.array){h++;const t=e.array,o=e.dict,i=o.c,u=1!==o.dbl,f=1!==o.noshade,d=1!==o.notex,m=1===o.prio,g=o.uv.array,p=n[(u?0:1)+(f?0:2)+(d?0:4)+(m?0:8)],x=p.vertices,v=p.triangles,_=p.normals,T=p.uvs,E=p.colorUVs,A=1/256+i*(1/128),w=1,b=Math.floor(x.length/3),y=[],R=[];for(let e=0;e<t.length;e++){const r=a[t[e]-1],n=a[t[0===e?t.length-1:e-1]-1];y.push(r),s.push(r[0],r[1],r[2],n[0],n[1],n[2]),R.push([g[2*e]/16,g[2*e+1]/16])}const B=c(y);if(4===t.length&&d&&r>1){const t=y[0],e=y[1],n=y[2],a=y[3],o=R[0],i=R[1],s=R[2],c=R[3];for(let h=0;h<=r;h++){const u=h/r,f=[l(t[0],e[0],u),l(t[1],e[1],u),l(t[2],e[2],u),l(o[0],i[0],u),l(o[1],i[1],u)],d=[l(a[0],n[0],u),l(a[1],n[1],u),l(a[2],n[2],u),l(c[0],s[0],u),l(c[1],s[1],u)];for(let t=0;t<=r;t++){const e=t/r;x.push(l(f[0],d[0],e),l(f[1],d[1],e),l(f[2],d[2],e)),T.push(l(f[3],d[3],e),l(f[4],d[4],e)),E.push(A,w),_.push(B[0],B[1],B[2])}}for(let t=0;t<r;t++)for(let e=0;e<r;e++){const n=e*(r+1),a=b+n+t+1,o=b+n+t+r+1;v.push(b+n+t,a,o,o,a,b+n+t+r+2)}}else{for(const t of y)x.push(t[0],t[1],t[2]),_.push(B[0],B[1],B[2]);for(let t=0;t<R.length;t++)if(E.push(A,w),d){const e=R[t];T.push(e[0],e[1])}else T.push(A,w);for(let e=0,r=t.length-2;e<r;e++)v.push(b+1+e,b,b+2+e)}}}for(const t of n)t.save();return a.save(),{passes:n,wireframe:a,faceCount:h,objectCount:e.array.length}}(t,_,s+1),b=function(t,e){const r=new ImageData(128,128),o=r.data,i=Array(16384).fill(255),s=Array(16).fill(!1);let l,c=0,h=0;for(let r=0;r<120;r++){[l,t]=n(t);for(let t=0;t<128;t++){const r=Number.parseInt(l.charAt(t),16);if(s[r]=!0,r===e)i[c]=255;else{i[c]=r;const t=a[r];o[h]=t[0],o[h+1]=t[1],o[h+2]=t[2],o[h+3]=255}c++,h+=4}}for(let t=0;t<16;t++){i[16256+t]=t;const e=a[t],r=65024+4*t;o[r]=e[0],o[r+1]=e[1],o[r+2]=e[2],o[r+3]=255}return{data:r,indices:i,flags:s}}(n(v)[1],p);return{name:d,zoomLevel:m,backgroundIndex:g,alphaIndex:p,passes:T,wireframe:w,texture:b.data,textureFlags:b.flags,textureIndices:b.indices,faceCount:E,objectCount:A}}function l(t,e,r){return t+(e-t)*r}function c(t){for(let n=0;n<t.length;n++){const a=t[n],o=t[(n+1)%t.length],i=t[(n+2)%t.length],s=[a[0]-o[0],a[1]-o[1],a[2]-o[2]],l=[o[0]-i[0],o[1]-i[1],o[2]-i[2]],c=(r=s,[(e=l)[1]*r[2]-e[2]*r[1],e[2]*r[0]-e[0]*r[2],e[0]*r[1]-e[1]*r[0]]),u=h(c);if(u>0)return[c[0]/u,c[1]/u,c[2]/u]}var e,r;return[1,0,0]}function h(t){return Math.hypot(t[0],t[1],t[2])}class u{constructor(t,e,r){this.gl=t;const n=this.createShader(t.VERTEX_SHADER,e),a=this.createShader(t.FRAGMENT_SHADER,r);if(this.program=t.createProgram(),t.attachShader(this.program,n),t.attachShader(this.program,a),t.linkProgram(this.program),t.deleteShader(n),t.deleteShader(a),!t.getProgramParameter(this.program,t.LINK_STATUS)){const e=t.getProgramInfoLog(this.program);throw t.deleteProgram(this.program),Error("program compilation failed: "+e)}this.vertexLocation=this.getAttribLocation("vertex"),this.uvLocation=this.getAttribLocation("uv"),this.mvpLocation=this.getUniformLocation("mvp")}createShader(t,e){const r=this.gl,n=r.createShader(t);if(r.shaderSource(n,e),r.compileShader(n),!r.getShaderParameter(n,r.COMPILE_STATUS)){const e=r.getShaderInfoLog(n);throw r.deleteShader(n),Error(`${t===r.FRAGMENT_SHADER?"fragment":"vertex"} shader compilation failed: ${e}`)}return n}getAttribLocation(t){return this.gl.getAttribLocation(this.program,t)}getUniformLocation(t){return this.gl.getUniformLocation(this.program,t)}use(){this.gl.useProgram(this.program)}free(){this.gl.deleteProgram(this.program)}}function f(t,e,r){const n=new ImageData(t,e),o=n.data,i=t*e;let s=0;for(let t=0;t<i;t++){const e=a[parseInt(r.charAt(t),16)];o[s]=e[0],o[s+1]=e[1],o[s+2]=e[2],o[s+3]=255,s+=4}return n}const d=document.getElementById("texture"),m=document.getElementById("viewport"),g=document.getElementById("input-resolution"),p=document.getElementById("input-auto-turn"),x=document.getElementById("input-wireframe"),v=document.getElementById("input-wireframe-color"),_=document.getElementById("input-render-mode"),T=document.getElementById("input-shading"),E=document.getElementById("input-fov"),A=document.getElementById("btn-show-controls"),w=document.getElementById("popup-controls"),b=document.getElementById("stats"),y=new class{constructor(t={}){this.canvas=t.canvas,null==this.canvas&&(this.canvas=document.createElement("canvas"));const e=this.gl=this.canvas.getContext("webgl",{antialias:!1});this.cameraPosition={x:0,y:0,z:0},this.cameraRotation={x:0,y:0,z:0},this.cameraFOV=t.fov??90,this.loaded=!1,this.model=null,this.shading=t.shading??!0,this.renderMode=t.renderMode??"texture",this.drawWireframe=t.drawWireframe??!1,this.wireframeXray=t.wireframeXray??!0,this.wireframeColor=t.wireframeColor??[1,1,1],this.tesselationCount=t.tesselationCount??3,this.lightDirection=t.lightDirection??{x:1,y:-1,z:0},this._passes=[],this._mainTex=null,this._indexTex=null,this._lightMapTex=this._createTexture(null,e.RGB,e.RGB,e.UNSIGNED_BYTE,f(32,4,"00112233445566778899aabbccddeeff0010213542516d768294a9b3cdd5e8fe000011552211dd6622449933dd55889900000011110055dd1122445555112244")),this._colorLightMapTex=this._createTexture(null,e.RGB,e.RGB,e.UNSIGNED_BYTE,f(32,7,"00112233445566778899aabbccddeeff0011223542556d768894a9bbccddeefe001122552255dd66884499bbccddeeee001021512251d56d824294b3cdd5e8e800001111221155dd22224433dd55888800001010211151d521224235d551828200000000111111551122225555112222")),this._programTexture=function(t){const e=new u(t,"\n\t\tattribute vec4 vertex;\n\t\tattribute vec3 normal;\n\t\tattribute vec2 uv;\n\n\t\tvarying highp vec2 v_uv;\n\t\tvarying highp vec3 v_normal;\n\n\t\tuniform mat4 mvp;\n\n\t\tvoid main() {\n\t\t\tv_normal = normal;\n\t\t\tv_uv = uv;\n\t\t\tgl_Position = mvp * vertex;\n\t\t}\n\t","\n\t\tvarying highp vec2 v_uv;\n\t\tvarying highp vec3 v_normal;\n\t\t\n\t\tuniform sampler2D indexTex;\n\t\tuniform sampler2D lightMap;\n\t\tuniform highp vec3 lightDir;\n\t\tuniform highp float lightMapOffset;\n\t\tuniform highp float lightMapGradient;\n\n\t\tvoid main() {\n\t\t\thighp float index = texture2D(indexTex, v_uv).r;\n\t\t\tif (index == 1.0) discard;\n\t\t\t// highp float intensity = clamp(4.0 * abs(dot(v_normal, lightDir)) - 1.0, 0.0, 1.0);\n\t\t\thighp float intensity = clamp(lightMapGradient * abs(dot(v_normal, lightDir)) + lightMapOffset, 0.0, 1.0);\n\t\t\tgl_FragColor = texture2D(lightMap, vec2(index * 15.9375 + mod(gl_FragCoord.x + gl_FragCoord.y, 2.0) * 0.03125, 1.0 - intensity));\n\t\t}\n\t");return{program:e,locations:{uv:e.getAttribLocation("uv"),normal:e.getAttribLocation("normal"),indexTex:e.getUniformLocation("indexTex"),lightMap:e.getUniformLocation("lightMap"),lightDir:e.getUniformLocation("lightDir"),lightMapOffset:e.getUniformLocation("lightMapOffset"),lightMapGradient:e.getUniformLocation("lightMapGradient")}}}(e),this._programUnlitTexture=function(t){const e=new u(t,"\n\t\tattribute vec4 vertex;\n\t\tattribute vec2 uv;\n\n\t\tvarying highp vec2 v_uv;\n\n\t\tuniform mat4 mvp;\n\n\t\tvoid main() {\n\t\t\tv_uv = uv;\n\t\t\tgl_Position = mvp * vertex;\n\t\t}\n\t","\n\t\tvarying highp vec2 v_uv;\n\t\t\n\t\tuniform sampler2D mainTex;\n\n\t\tvoid main() {\n\t\t\tlowp vec4 color = texture2D(mainTex, v_uv);\n\t\t\tif (color.a == 0.0) discard;\n\t\t\tgl_FragColor = color;\n\t\t}\n\t");return{program:e,locations:{mainTex:e.getUniformLocation("mainTex")}}}(e),this._wireframe=null,this._programWireframe=function(t){const e=new u(t,"\n\t\tattribute vec4 vertex;\n\n\t\tuniform mat4 mvp;\n\n\t\tvoid main() {\n\t\t\tgl_Position = mvp * vertex;\n\t\t}\n\t","\n\t\tuniform lowp vec4 color;\n\n\t\tvoid main() {\n\t\t\tgl_FragColor = color;\n\t\t}\n\t");return{program:e,locations:{color:e.getUniformLocation("color")}}}(e),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL)}_createTexture(t,e,r,n,a,o,i){const s=this.gl;return null==t&&(t=s.createTexture()),s.bindTexture(s.TEXTURE_2D,t),null==o?s.texImage2D(s.TEXTURE_2D,0,e,r,n,a):s.texImage2D(s.TEXTURE_2D,0,e,o,i,0,r,n,a),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),t}async load(t){if("string"==typeof t)t.startsWith("picocad;")?this._loadString(t):await this._loadUrl(t);else if(t instanceof URL)await this._loadUrl(t);else{if(!(t instanceof Blob))throw TypeError();await this._loadBlob(t)}return this.model.name}async _loadUrl(t){const e=await fetch(String(t));if(!e.ok)throw Error(`${e.status}: ${e.statusText}`);this._loadString(await e.text())}_loadBlob(t){return new Promise(((e,r)=>{if(!t.type.startsWith("text"))throw Error("picoCAD file must be a text file");const n=new FileReader;n.onload=()=>{e(this._loadString(n.result))},n.onerror=()=>{r(n.error)},n.readAsText(t)}))}_loadString(t){const e=this.gl;if(this.loaded){for(const t of this._passes)t.free();this._passes=[],this._wireframe.free(),e.deleteTexture(this._mainTex),this._mainTex=null,e.deleteTexture(this._indexTex),this._indexTex=null}this.loaded=!1;const r=s(this.gl,t,this.tesselationCount);this.model={name:r.name,zoomLevel:r.zoomLevel,backgroundIndex:r.backgroundIndex,backgroundColor:a[r.backgroundIndex],alphaIndex:r.alphaIndex,alphaColor:a[r.alphaIndex],texture:r.texture,textureColorFlags:r.textureFlags,faceCount:r.faceCount,objectCount:r.objectCount},this._passes=r.passes,this._wireframe=r.wireframe,this._mainTex=this._createTexture(this._mainTex,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r.texture),this._indexTex=this._createTexture(this._indexTex,e.LUMINANCE,e.LUMINANCE,e.UNSIGNED_BYTE,new Uint8Array(r.textureIndices),128,128),this.loaded=!0}draw(){const e="none"!==this.renderMode,r="color"===this.renderMode;if(!this.loaded||!e&&!this.drawWireframe)return;const n=this.gl;n.viewport(0,0,n.canvas.width,n.canvas.height);const a=this.model.backgroundColor;n.clearColor(a[0]/255,a[1]/255,a[2]/255,1),n.clearDepth(1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);const o=(i=new t(16),t!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0),i[0]=1,i[5]=1,i[10]=1,i[15]=1,i);var i;!function(t,e,r,n,a){var o,i=1/Math.tan(e/2);t[0]=i/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=a&&a!==1/0?(o=1/(n-a),t[10]=(a+n)*o,t[14]=2*a*n*o):(t[10]=-1,t[14]=-2*n)}(o,this.cameraFOV*Math.PI/180,this.canvas.width/this.canvas.height,.1,400),function(t,e,r){var n=Math.sin(r),a=Math.cos(r),o=e[4],i=e[5],s=e[6],l=e[7],c=e[8],h=e[9],u=e[10],f=e[11];e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*a+c*n,t[5]=i*a+h*n,t[6]=s*a+u*n,t[7]=l*a+f*n,t[8]=c*a-o*n,t[9]=h*a-i*n,t[10]=u*a-s*n,t[11]=f*a-l*n}(o,o,this.cameraRotation.x),function(t,e,r){var n=Math.sin(r),a=Math.cos(r),o=e[0],i=e[1],s=e[2],l=e[3],c=e[8],h=e[9],u=e[10],f=e[11];e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*a-c*n,t[1]=i*a-h*n,t[2]=s*a-u*n,t[3]=l*a-f*n,t[8]=o*n+c*a,t[9]=i*n+h*a,t[10]=s*n+u*a,t[11]=l*n+f*a}(o,o,this.cameraRotation.y),function(t,e,r){var n=Math.sin(r),a=Math.cos(r),o=e[0],i=e[1],s=e[2],l=e[3],c=e[4],h=e[5],u=e[6],f=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*a+c*n,t[1]=i*a+h*n,t[2]=s*a+u*n,t[3]=l*a+f*n,t[4]=c*a-o*n,t[5]=h*a-i*n,t[6]=u*a-s*n,t[7]=f*a-l*n}(o,o,this.cameraRotation.z),function(t,e,r){var n,a,o,i,s,l,c,h,u,f,d,m,g=r[0],p=r[1],x=r[2];e===t?(t[12]=e[0]*g+e[4]*p+e[8]*x+e[12],t[13]=e[1]*g+e[5]*p+e[9]*x+e[13],t[14]=e[2]*g+e[6]*p+e[10]*x+e[14],t[15]=e[3]*g+e[7]*p+e[11]*x+e[15]):(n=e[0],a=e[1],o=e[2],i=e[3],s=e[4],l=e[5],c=e[6],h=e[7],u=e[8],f=e[9],d=e[10],m=e[11],t[0]=n,t[1]=a,t[2]=o,t[3]=i,t[4]=s,t[5]=l,t[6]=c,t[7]=h,t[8]=u,t[9]=f,t[10]=d,t[11]=m,t[12]=n*g+s*p+u*x+e[12],t[13]=a*g+l*p+f*x+e[13],t[14]=o*g+c*p+d*x+e[14],t[15]=i*g+h*p+m*x+e[15])}(o,o,[this.cameraPosition.x,this.cameraPosition.y,this.cameraPosition.z]);const s=function(t){let e=Math.hypot(t.x,t.y,t.z);0===e&&(e=1);return{x:t.x/e,y:t.y/e,z:t.z/e}}(this.lightDirection);if(e)for(const t of this._passes){if(t.clearDepth&&n.clear(n.DEPTH_BUFFER_BIT),t.isEmpty())continue;const e=r||!t.texture,a=this.shading&&t.shading?this._programTexture:this._programUnlitTexture;a.program.use(),n.uniformMatrix4fv(a.program.mvpLocation,!1,o),n.bindBuffer(n.ARRAY_BUFFER,t.vertexBuffer),n.vertexAttribPointer(a.program.vertexLocation,3,n.FLOAT,!1,0,0),n.enableVertexAttribArray(a.program.vertexLocation),n.bindBuffer(n.ARRAY_BUFFER,e?t.colorUVBuffer:t.uvBuffer),n.vertexAttribPointer(a.program.uvLocation,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(a.program.uvLocation),a===this._programUnlitTexture?(n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._mainTex),n.uniform1i(a.locations.mainTex,0)):a===this._programTexture&&(n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._indexTex),n.uniform1i(a.locations.indexTex,0),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,e?this._colorLightMapTex:this._lightMapTex),n.uniform1i(a.locations.lightMap,1),n.uniform1f(a.locations.lightMapOffset,e?-.316326530612245:-.3571428571428572),n.uniform1f(a.locations.lightMapGradient,e?1.63265306122449:2.857142857142857),n.uniform3f(a.locations.lightDir,s.x,s.y,s.z),n.bindBuffer(n.ARRAY_BUFFER,t.normalBuffer),n.vertexAttribPointer(a.locations.normal,3,n.FLOAT,!1,0,0),n.enableVertexAttribArray(a.locations.normal)),t.cull?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.triangleBuffer),n.drawElements(n.TRIANGLES,t.vertexCount,n.UNSIGNED_SHORT,0),n.disableVertexAttribArray(a.program.vertexLocation),n.disableVertexAttribArray(a.program.uvLocation),a===this._programTexture&&n.disableVertexAttribArray(a.locations.normal)}this.drawWireframe&&(e&&this.wireframeXray&&n.clear(n.DEPTH_BUFFER_BIT),this._programWireframe.program.use(),n.uniformMatrix4fv(this._programWireframe.program.mvpLocation,!1,o),n.uniform4fv(this._programWireframe.locations.color,[this.wireframeColor[0],this.wireframeColor[1],this.wireframeColor[2],1]),n.bindBuffer(n.ARRAY_BUFFER,this._wireframe.vertexBuffer),n.vertexAttribPointer(this._programWireframe.program.vertexLocation,3,n.FLOAT,!1,0,0),n.enableVertexAttribArray(this._programWireframe.program.vertexLocation),n.drawArrays(n.LINES,0,this._wireframe.vertexCount))}startDrawLoop(t){let e=performance.now();const r=()=>{if(null!=t){const r=performance.now();t((r-e)/1e3),e=r}this.draw(),this._rafID=requestAnimationFrame(r)};r()}stopDrawLoop(){null!=this._rafID&&cancelAnimationFrame(this._rafID)}getCameraRight(){return this._transformDirection(1,0,0)}getCameraUp(){return this._transformDirection(0,-1,0)}getCameraForward(){return this._transformDirection(0,0,-1)}setLightDirectionFromCamera(){const t=this.getCameraUp(),e=this.getCameraForward();this.lightDirection={x:e.x-.4*t.x,y:e.y-.4*t.y,z:e.z-.4*t.z}}getTextureColorCount(t=!1){let e=0;for(let r=0;r<16;r++)(t||r!==this.model.alphaIndex)&&this.model.textureColorFlags[r]&&e++;return e}getTriangleCount(){let t=0;for(const e of this._passes)t+=Math.floor(e.vertexCount/3);return t}getDrawCallCount(){let t=0;for(const e of this._passes)e.isEmpty()||t++;return this.drawWireframe&&t++,t}_transformDirection(t,r,n){const a=e();!function(t,e,r,n){t[0]=e,t[1]=r,t[2]=n}(a,t,r,n);const o=((i=e())[0]=0,i[1]=0,i[2]=0,i);var i;return function(t,e,r,n){var a=[],o=[];a[0]=e[0]-r[0],a[1]=e[1]-r[1],a[2]=e[2]-r[2],o[0]=a[0],o[1]=a[1]*Math.cos(n)-a[2]*Math.sin(n),o[2]=a[1]*Math.sin(n)+a[2]*Math.cos(n),t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2]}(a,a,o,Math.PI+this.cameraRotation.x),function(t,e,r,n){var a=[],o=[];a[0]=e[0]-r[0],a[1]=e[1]-r[1],a[2]=e[2]-r[2],o[0]=a[2]*Math.sin(n)+a[0]*Math.cos(n),o[1]=a[1],o[2]=a[2]*Math.cos(n)-a[0]*Math.sin(n),t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2]}(a,a,o,this.cameraRotation.y),function(t,e,r,n){var a=[],o=[];a[0]=e[0]-r[0],a[1]=e[1]-r[1],a[2]=e[2]-r[2],o[0]=a[0]*Math.cos(n)-a[1]*Math.sin(n),o[1]=a[0]*Math.sin(n)+a[1]*Math.cos(n),o[2]=a[2],t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2]}(a,a,o,Math.PI+this.cameraRotation.z),{x:a[0],y:a[1],z:a[2]}}setTurntableCamera(t,e,r,n={x:0,y:1.5,z:0}){const a=Math.PI-e;r=-r,this.cameraPosition={x:t*Math.cos(r)*Math.sin(a)-n.x,y:t*Math.sin(r)-n.y,z:t*Math.cos(r)*Math.cos(a)-n.z},this.cameraRotation={y:e,x:-r,z:0}}free(){const t=this.gl;this.stopDrawLoop();for(const t of this._passes)t.free();this._passes=[],t.deleteTexture(this._lightMapTex),t.deleteTexture(this._colorLightMapTex),t.deleteTexture(this._mainTex),t.deleteTexture(this._indexTex),this._lightMapTex=null,this._colorLightMapTex=null,this._mainTex=null,this._indexTex=null,this._programTexture.program.free(),this._programWireframe.program.free(),this._programTexture=null,this._programWireframe=null}}({canvas:m});window.viewer=y;let R=-Math.PI/2,B=.2,C=12,D=.75,L={x:0,y:1.5,z:0},F=!0,M=0;const U=d.getContext("2d");function I(){for(C=y.model.zoomLevel,m.classList.add("loaded"),U.putImageData(y.model.texture,0,0);null!=b.lastChild;)b.lastChild.remove();b.append(H("li",{},y.model.name));const t={Colors:y.getTextureColorCount(),Objects:y.model.objectCount,Faces:y.model.faceCount};console.log(`${y.getTriangleCount()} triangles, ${y.getDrawCallCount()} draw calls`);for(const[e,r]of Object.entries(t))b.append(H("li",{},`${e}: ${r}`))}function S(t){"r"===t?O(!y.drawWireframe):"t"===t?Y(!F):"m"===t?X("texture"===_.value?"color":"texture"):"l"===t?G(!T.checked):"/"!==t&&"?"!==t||y.load("./example.txt").then(I)}document.querySelectorAll(".popup").forEach((t=>{t.addEventListener("click",(()=>{w.hidden=!w.hidden}))})),A.onclick=()=>{w.hidden=!w.hidden},w.querySelectorAll("kbd").forEach((t=>{t.onclick=()=>S(t.textContent.toLowerCase())}));const P=Object.create(null);window.onkeydown=t=>{if(!t.ctrlKey&&!t.metaKey){t.preventDefault();const e=t.key.toLowerCase();P[e]=!0,S(e)}},window.onkeyup=t=>{t.ctrlKey||t.metaKey||(t.preventDefault(),P[t.key.toLowerCase()]=!1)},m.ondblclick=()=>{y.loaded&&m.requestPointerLock()},m.oncontextmenu=t=>{t.preventDefault()},document.onpointerlockchange=t=>{M=document.pointerLockElement===m?1:0};let k=Array(5).fill(!1),N=Array(5).fill(!1),z=[0,0];window.onmousedown=t=>{const e=t.button,r=t.target==m;k[e]=!0,N[e]=r,r&&(t.preventDefault(),m.classList.add("grabbing"),0===M&&0===e&&Y(!1))},window.onmouseup=t=>{const e=t.button;k[e]=!1,N[e]=!1,m.classList.remove("grabbing")},window.onmousemove=t=>{const e=[t.clientX,t.clientY],r=[e[0]-z[0],e[1]-z[1]];if(1===M&&document.pointerLockElement===m){const e=.003;R+=t.movementX*e,B+=t.movementY*e}else if(0==M)if(N[0]){const t=.005;R+=r[0]*t,B+=r[1]*t}else if(N[1]||N[2]){const t=.005,e=y.getCameraUp(),n=y.getCameraRight(),a=r[0]*t,o=-r[1]*t;L.x+=n.x*a+e.x*o,L.y+=n.y*a+e.y*o,L.z+=n.z*a+e.z*o}z=e},m.onwheel=t=>{t.preventDefault();const e=j(-6,6,t.deltaY);1===M||0===M&&t.altKey?W(y.cameraFOV+e):0===M&&(C=j(0,200,C+.5*e))},$(g,(t=>{const[e,r,n]=t.split(",").map((t=>Number(t)));m.width=e,m.height=r,m.style.maxWidth=e*n+"px"}));const W=$(E,(()=>{y.cameraFOV=E.valueAsNumber,E.nextElementSibling.textContent=E.value})),O=$(x,(()=>{y.drawWireframe=x.checked})),Y=$(p,(()=>{F=p.checked}));$(v,(t=>{y.wireframeColor=[t.slice(1,3),t.slice(3,5),t.slice(5,7)].map((t=>parseInt(t,16)/255))}));const X=$(_,(t=>{y.renderMode=t})),G=$(T,(()=>{y.shading=T.checked}));function V(){document.body.classList.remove("drag")}function j(t,e,r){return r<t?t:r>e?e:r}function H(t,e,...r){if(t=t instanceof Element?t:document.createElement(t),null!=e)for(const r in e)t.setAttribute(r,e[r]);return t.append(...r),t}function $(t,e){function r(){e(t.value)}return t[t instanceof HTMLSelectElement?"onchange":"oninput"]=r,r(),t instanceof HTMLInputElement?e=>{"boolean"==typeof e?t.checked=e:t.value=e,r()}:e=>{t.value=e,r()}}y.startDrawLoop((t=>{const e=1.2*t;let r=0,n=0,a=0,o=0,i=0;if(P.w&&(n+=1),P.s&&(n-=1),P.a&&(r-=1),P.d&&(r+=1),(P.q||P.shift||P.control)&&(a-=1),(P.e||P[" "])&&(a+=1),P.arrowleft&&(o-=1),P.arrowright&&(o+=1),P.arrowup&&(i-=1),P.arrowdown&&(i+=1),0===M)B+=(n+i)*e,L.y+=3*a*t,F?(D-=2*(r+o)*t,D=j(-2,2,D),R+=D*t):R+=(r+o)*e,y.setTurntableCamera(C,R,B,L);else if(1===M&&(R+=o*e,B+=i*e,B=j(-Math.PI/2,Math.PI/2,B),y.cameraRotation.x=B,y.cameraRotation.y=R,0!==r||0!==a||0!==n)){const e=6*t,o=y.getCameraRight(),i=y.getCameraUp(),s=y.getCameraForward(),l=y.cameraPosition;l.x+=(o.x*r+s.x*n+i.x*a)*e,l.y+=(o.y*r+s.y*n+i.y*a)*e,l.z+=(o.z*r+s.z*n+i.z*a)*e}y.setLightDirectionFromCamera()})),window.addEventListener("dragover",(t=>{t.preventDefault()})),window.addEventListener("dragenter",(t=>{t.dataTransfer.types.includes("Files")&&document.body.classList.add("drag")})),window.addEventListener("dragexit",(t=>{V()})),window.addEventListener("drop",(t=>{t.preventDefault(),V();const e=t.dataTransfer.files[0];null!=e&&y.load(e).then(I)})),document.body.addEventListener("paste",(t=>{const e=t.clipboardData.getData("text/plain");if(null!=e)y.load(e).then(I);else{const e=t.clipboardData.files[0];null!=e&&y.load(e).then(I)}})),window.ramp=function(t,e){return{offset:.5-t/e,gradient:1/e}}}();
